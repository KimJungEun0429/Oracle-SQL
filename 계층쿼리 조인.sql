CREATE TABLE EMPLOYEE_TBL
(
    E_ID        CHAR(4)     NOT NULL  PRIMARY KEY, -- 사원아이디
    E_NAME      VARCHAR2(30)    NOT NULL,          -- 사원이름
    PART_ID     CHAR(6)         NOT NULL           -- 소속부서, 팀
);--부서와 팀을 따로 만들어놓는 것은 불가능하다. 조직개편으로 부서가 사라지면 팀만 남아버림

INSERT INTO EMPLOYEE_TBL VALUES('E001','홍길동1','PT0002');  --인사부
INSERT INTO EMPLOYEE_TBL VALUES('E002','홍길동2','PT0002');  --인사부
INSERT INTO EMPLOYEE_TBL VALUES('E003','홍길동3','PT0002');  --인사부
INSERT INTO EMPLOYEE_TBL VALUES('E004','홍길동4','PT0011');  --총무부 1-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E005','홍길동5','PT0011');  --총무부 1-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E006','홍길동6','PT0012');  --총무부 1-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E007','홍길동7','PT0012');  --총무부 1-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E008','홍길동8','PT0012');  --총무부 1-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E009','홍길동9','PT0013');  --총무부 2-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E010','홍길동10','PT0013'); --총무부 2-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E011','홍길동11','PT0014'); --총무부 2-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E012','홍길동12','PT0014'); --총무부 2-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E013','홍길동13','PT0014'); --총무부 2-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E014','홍길동14','PT0014'); --총무부 2-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E015','홍길동15','PT0015'); --총무부 3-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E016','홍길동16','PT0015'); --총무부 3-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E017','홍길동17','PT0037'); --총무부 3-2-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E018','홍길동18','PT0037'); --총무부 3-2-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E019','홍길동19','PT0038'); --총무부 3-2-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E020','홍길동20','PT0038'); --총무부 3-2-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E021','홍길동21','PT0017'); --총무부 3-3팀
INSERT INTO EMPLOYEE_TBL VALUES('E022','홍길동22','PT0017'); --총무부 3-3팀
INSERT INTO EMPLOYEE_TBL VALUES('E023','홍길동23','PT0018'); --생산부 1-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E024','홍길동24','PT0018'); --생산부 1-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E025','홍길동25','PT0018'); --생산부 1-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E026','홍길동26','PT0019'); --생산부 1-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E027','홍길동27','PT0019'); --생산부 1-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E028','홍길동28','PT0019'); --생산부 1-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E029','홍길동29','PT0020'); --생산부 1-3팀
INSERT INTO EMPLOYEE_TBL VALUES('E030','홍길동30','PT0020'); --생산부 1-3팀
INSERT INTO EMPLOYEE_TBL VALUES('E031','홍길동31','PT0020'); --생산부 1-3팀
INSERT INTO EMPLOYEE_TBL VALUES('E032','홍길동32','PT0020'); --생산부 1-3팀
INSERT INTO EMPLOYEE_TBL VALUES('E033','홍길동33','PT0021'); --생산부 1-4팀
INSERT INTO EMPLOYEE_TBL VALUES('E034','홍길동34','PT0021'); --생산부 1-4팀
INSERT INTO EMPLOYEE_TBL VALUES('E035','홍길동35','PT0021'); --생산부 1-4팀
INSERT INTO EMPLOYEE_TBL VALUES('E036','홍길동36','PT0021'); --생산부 1-4팀
INSERT INTO EMPLOYEE_TBL VALUES('E037','홍길동37','PT0021'); --생산부 1-4팀
INSERT INTO EMPLOYEE_TBL VALUES('E038','홍길동38','PT0022'); --생산부 2-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E039','홍길동39','PT0022'); --생산부 2-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E040','홍길동40','PT0023'); --생산부 2-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E041','홍길동41','PT0023'); --생산부 2-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E042','홍길동42','PT0024'); --생산부 3-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E043','홍길동43','PT0024'); --생산부 3-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E044','홍길동44','PT0025'); --생산부 3-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E045','홍길동45','PT0025'); --생산부 3-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E046','홍길동46','PT0025'); --생산부 3-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E047','홍길동47','PT0039'); --생산부 3-3-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E048','홍길동48','PT0039'); --생산부 3-3-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E049','홍길동49','PT0039'); --생산부 3-3-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E050','홍길동50','PT0039'); --생산부 3-3-1팀
INSERT INTO EMPLOYEE_TBL VALUES('E051','홍길동51','PT0040'); --생산부 3-3-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E052','홍길동52','PT0040'); --생산부 3-3-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E053','홍길동53','PT0040'); --생산부 3-3-2팀
INSERT INTO EMPLOYEE_TBL VALUES('E054','홍길동54','PT0041'); --생산부 3-3-3팀
INSERT INTO EMPLOYEE_TBL VALUES('E055','홍길동55','PT0041'); --생산부 3-3-3팀

SELECT * FROM EMPLOYEE_TBL;
--COMMIT;

CREATE TABLE PARTS_TBL -- 부서, 팀 테이블
(
    PART_ID     CHAR(6)         NOT NULL, -- 부서, 팀 아이디
    PART_NAME   VARCHAR2(30)    NOT NULL, -- 부서, 팀 이름
    PART_LVL    NUMBER(4)       NOT NULL, -- 부서, 팀 레벨
    PART_SEQ    NUMBER(4)       NOT NULL, -- 정렬순서를 나타내는 순서값
    PARENT_PART_ID  CHAR(6)     NULL      -- 부서, 팀의 부모아이디(PARENT IN)
);

--DROP TABLE PARTS_TBL;
INSERT INTO PARTS_TBL VALUES('PT0001','ROOT',0, 1, NULL);
--얘를 만들어놓은 이유는 조직도라는 제목(젤 꼭짓점)을 만들어놓은 것과 같다 1:다를 걸어주기 위하여


INSERT INTO PARTS_TBL VALUES('PT0002','인사부',1, 1, 'PT0001');
INSERT INTO PARTS_TBL VALUES('PT0003','총무부',1, 2, 'PT0001');
INSERT INTO PARTS_TBL VALUES('PT0004','생산부',1, 3, 'PT0001');

INSERT INTO PARTS_TBL VALUES('PT0005','총무부 1팀',2, 1, 'PT0003');
INSERT INTO PARTS_TBL VALUES('PT0006','총무부 2팀',2, 2, 'PT0003');
INSERT INTO PARTS_TBL VALUES('PT0007','총무부 3팀',2, 3, 'PT0003');

INSERT INTO PARTS_TBL VALUES('PT0008','생산부 1팀',2, 1, 'PT0004');
INSERT INTO PARTS_TBL VALUES('PT0009','생산부 2팀',2, 2, 'PT0004');
INSERT INTO PARTS_TBL VALUES('PT0010','생산부 3팀',2, 3, 'PT0004');

INSERT INTO PARTS_TBL VALUES('PT0011','총무부 1-1팀',3, 1, 'PT0005');
INSERT INTO PARTS_TBL VALUES('PT0012','총무부 1-2팀',3, 2, 'PT0005');

INSERT INTO PARTS_TBL VALUES('PT0013','총무부 2-1팀',3, 1, 'PT0006');
INSERT INTO PARTS_TBL VALUES('PT0014','총무부 2-2팀',3, 2, 'PT0006');

INSERT INTO PARTS_TBL VALUES('PT0015','총무부 3-1팀',3, 1, 'PT0007');
INSERT INTO PARTS_TBL VALUES('PT0016','총무부 3-2팀',3, 2, 'PT0007');
INSERT INTO PARTS_TBL VALUES('PT0017','총무부 3-3팀',3, 3, 'PT0007');

INSERT INTO PARTS_TBL VALUES('PT0018','생산부 1-1팀',3, 1, 'PT0008');
INSERT INTO PARTS_TBL VALUES('PT0019','생산부 1-2팀',3, 2, 'PT0008');
INSERT INTO PARTS_TBL VALUES('PT0020','생산부 1-3팀',3, 3, 'PT0008');
INSERT INTO PARTS_TBL VALUES('PT0021','생산부 1-4팀',3, 4, 'PT0008');

INSERT INTO PARTS_TBL VALUES('PT0022','생산부 2-1팀',3, 1, 'PT0009');
INSERT INTO PARTS_TBL VALUES('PT0023','생산부 2-2팀',3, 2, 'PT0009');

INSERT INTO PARTS_TBL VALUES('PT0024','생산부 3-1팀',3, 1, 'PT0010');
INSERT INTO PARTS_TBL VALUES('PT0025','생산부 3-2팀',3, 2, 'PT0010');
INSERT INTO PARTS_TBL VALUES('PT0026','생산부 3-3팀',3, 3, 'PT0010');

INSERT INTO PARTS_TBL VALUES('PT0037','총무부 3-2-1팀',4, 1, 'PT0016');
INSERT INTO PARTS_TBL VALUES('PT0038','총무부 3-2-2팀',4, 2, 'PT0016');

INSERT INTO PARTS_TBL VALUES('PT0039','생산부 3-3-1팀',4, 1, 'PT0026');
INSERT INTO PARTS_TBL VALUES('PT0040','생산부 3-3-2팀',4, 2, 'PT0026');
INSERT INTO PARTS_TBL VALUES('PT0041','생산부 3-3-3팀',4, 3, 'PT0026');

SELECT * FROM PARTS_TBL;

--COMMIT;


--1.계층형 데이터에 대한 이해를 필요로 함
--2. 1번이 이해가 되었다면 계층형 쿼리에 대한 이해를 필요로 함(10g버전 이상부터 문제 없이 작동. 하위 버전에선 약간의 문제가 있다)
--암기해야할 문법
    SELECT *
    FROM PARTS_TBL
    START WITH PART_NAME = 'ROOT'
    CONNECT BY PRIOR PART_ID = PARENT_PART_ID
    -- ORDER BY PART_NAME 이렇게 주면 생산부 다음에 생산부 1팀이 와야하는데 생산부 1-1팀이오기 때문에 현재 상태로 정렬을 해줄 방법은 없음
    --11부터 지원
    ORDER SIBLINGS BY PART_NAME
    --새로운 문법으로 정렬!
    ;
    --START WITH는 맨 꼭짓점을 이야기함, 맨위에서 내려올 수 있고 맨 아래에서 올라오면서 계층을 만들 수 있음 
    --START WITH 에는 데이터는 ROW이기 때문에 PT0001를 불러줄 수 있고 PARENT_PART_ID IS NULL라고 줄 수 있다.
    
    --총무부만 뽑아보시오
    SELECT * FROM PARTS_TBL
    START WITH PART_ID = 'PT0003'
    CONNECT BY PRIOR PART_ID = PARENT_PART_ID
    ;
--3. 계층형 데이터를 가지고 있는 테이블과의 조인
SELECT * FROM PARTS_TBL
WHERE PART_ID = 'PT0012'
;
--[총무부(PT0003/PT0001) 총무1팀(PT0005/PT0003) 총무1-2팀(PT0012/PT0005) 홍길동] 이렇게 뽑아내는 것이 3번 내용 

SELECT * FROM EMPLOYEE_TBL;
ORDER BY PART_ID;
SELECT * FROM PARTS_TBL;
    
    SELECT *
    FROM
        (
        SELECT *--T1.E_ID, T1.E_NAME, T1,PART_ID, T2.PART_NAME, T2.PARENT_PART_ID
        FROM EMPLOYEE_TBL T1, PARTS_TBL T2
        WHERE T1.PART_ID = T2.PART_ID
        AND T1.PART_ID = 'PT0012'
        )A, 
        (
        SELECT * FROM PARTS_TBL
        START WITH PART_ID = 'PT0003'
        CONNECT BY PRIOR PART_ID = PARENT_PART_ID
        )B
    
    ;
    ---------------------------------------내가 조인하려고 시도한 것
    
    SELECT *--PATR1.PART_NAME || '' || PATR2.PART_NAME || '' || PATR3.PART_NAME || '' || PATR4.PART_NAME 
    FROM
        (
            SELECT * FROM PARTS_TBL
            WHERE PART_LVL = 1
        ) PART1 ,
        (
            SELECT * FROM PARTS_TBL
            WHERE PART_LVL = 2
        ) PART2 ,
        (
            SELECT * FROM PARTS_TBL
            WHERE PART_LVL = 3
        ) PART3 ,
        (
            SELECT * FROM PARTS_TBL
            WHERE PART_LVL = 4
        ) PART4 
    WHERE PART1.PART_ID = PART2.PARENT_PART_ID(+)
    AND PART2.PART_ID = PART3.PARENT_PART_ID(+)
    AND PART3.PART_ID = PART4.PARENT_PART_ID(+)
    ;
    -----------------------------------------이렇게 조인 안된다~~~

SELECT T3.*,T4.*
FROM
(
    SELECT T3.PTID, T4.PID, T3.E_NAME, T3.T2PTID,T3.T1PTID, T3.PART_NAME, T4.PART_NAME, T4.PARENT_PART_ID 
    FROM
        ( 
              SELECT T2.E_NAME, T2.PART_ID AS T2PTID , T1.PART_ID AS T1PTID, T1.PART_NAME, T1.PARENT_PART_ID AS PTID
              FROM
              (
                SELECT PART_ID, PART_NAME, PARENT_PART_ID 
                FROM PARTS_TBL
                WHERE PART_LVL = '4'
              )T1, EMPLOYEE_TBL T2
              WHERE T1.PART_ID(+) = T2.PART_ID
        )T3,
      (
            SELECT PART_ID AS PID , PART_NAME, PART_LVL, PARENT_PART_ID
            FROM PARTS_TBL
            WHERE PART_LVL = '3'
      )T4
      WHERE T3.T1PID = T4.PID
;
  
    SELECT *
    FROM
    (
    SELECT 
    FROM PARTS_TBL T1,PARTS_TBL T2, PARTS_TBL T3 ,PARTS_TBL T4,PARTS_TBL T5
    WHERE T1.PART_ID = T2.PARENT_PART_ID(+)
    AND T2.PART_ID = T3.PARENT_PART_ID(+) 
    AND T3.PART_ID = T4.PARENT_PART_ID(+) 
    AND T4.PART_ID = T5.PARENT_PART_ID(+) 
    )A, EMPLOYEE_TBL T6
    WHERE A.PART_ID = T6.PART_ID
    ;
    
    SELECT * FROM EMPLOY
    
